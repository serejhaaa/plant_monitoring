name: DEV Deploy to VPS

on:
  push:
    branches:
      - dev # Запускать при пуше в ветку dev!!

jobs:
  deploy:
    environment: dev
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Включаем режим, при котором скрипт прерывается при любой ошибке
            set -e
            
            # --- БЛОК 1: Настройка сервера и PostgreSQL (только для локальной БД) ---
            # Сохраняем секреты в переменные для удобства
            DB_HOST="${{ secrets.DB_HOST }}"
            DB_NAME="${{ secrets.DB_NAME }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"

            # Проверяем, используется ли локальный хост для БД
            if [[ "$DB_HOST" == "127.0.0.1" ]] || [[ "$DB_HOST" == "localhost" ]]; then
              echo "DB_HOST is local. Checking PostgreSQL setup..."

              # 1. Обновление системных пакетов
              echo "Updating system packages..."
              sudo DEBIAN_FRONTEND=noninteractive apt-get update
              sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y

              # 2. Проверка и установка PostgreSQL
              if ! command -v psql &> /dev/null; then
                echo "PostgreSQL is not installed. Installing..."
                sudo apt-get install -y postgresql postgresql-contrib
              else
                echo "PostgreSQL is already installed."
              fi

              # 3. Проверка и создание пользователя PostgreSQL
              USER_EXISTS=$(sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='$DB_USER'")
              if [[ -z "$USER_EXISTS" ]]; then
                echo "Creating PostgreSQL user '$DB_USER'..."
                sudo -u postgres createuser "$DB_USER"
              fi
              # Устанавливаем/обновляем пароль для пользователя.
              echo "Setting password for user '$DB_USER'..."
              sudo -u postgres psql -c "ALTER USER \"$DB_USER\" WITH PASSWORD '$DB_PASSWORD';"
            else
              echo "DB_HOST is remote. Skipping local PostgreSQL setup."
            fi
            # --- КОНЕЦ БЛОКА 1 ---

            # Переходим в домашнюю директорию пользователя
            cd /home/${{ secrets.SERVER_USER }}
            
            # Создаем папку проекта, если она еще не существует.
            mkdir -p plant_monitoring
            cd plant_monitoring
            
            # Если это еще не git-репозиторий, делаем его им
            if [ ! -d ".git" ]; then
              echo "Initializing git repository..."
              git init              
            fi            
            
            echo "Setting remote origin URL..."
            git remote set-url origin https://github.com/serejhaaa/plant_monitoring.git
            
            # Обновляем код до состояния ветки main
            echo "Pulling latest changes from main branch..."
            git fetch origin main
            git reset --hard origin/main
            
            # Создаем/обновляем виртуальное окружение
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment..."
              python3 -m venv venv
            fi
            source venv/bin/activate
            
            # Сначала обновляем pip и setuptools до последних версий
            echo "Upgrading pip and setuptools..."
            /home/plant-deployer/plant_monitoring/venv/bin/pip install --upgrade pip setuptools
            
            # Устанавливаем/обновляем зависимости проекта
            echo "Installing requirements..."
            /home/plant-deployer/plant_monitoring/venv/bin/pip install -r requirements.txt
            
            # --- БЛОК 2: Универсальная проверка и создание БД ---
            echo "Checking for database '$DB_NAME'..."
            DB_EXISTS=false

            if [[ "$DB_HOST" == "127.0.0.1" ]] || [[ "$DB_HOST" == "localhost" ]]; then
              # Локальная проверка: запрос к системной таблице postgres
              if sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='$DB_NAME'" | grep -q 1; then
                DB_EXISTS=true
              fi
            else
              # Удаленная проверка: попытка подключения к БД
              echo "Performing remote database check..."
              export PGPASSWORD="$DB_PASSWORD"
              if psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1;" &> /dev/null; then
                DB_EXISTS=true
              fi
              unset PGPASSWORD
            fi

            if [ "$DB_EXISTS" = false ]; then
              echo "Database '$DB_NAME' does not exist."
              if [[ "$DB_HOST" == "127.0.0.1" ]] || [[ "$DB_HOST" == "localhost" ]]; then
                echo "Attempting to create local database..."
                sudo -u postgres createdb -O "$DB_USER" "$DB_NAME"
                echo "Database '$DB_NAME' created successfully."
              else
                echo "ERROR: Remote database '$DB_NAME' does not exist and cannot be created automatically."
                echo "Please create it manually on the remote server and re-run the deployment."
                exit 1
              fi
            else
              echo "Database '$DB_NAME' exists."
            fi
            # --- КОНЕЦ БЛОКА 2 ---
            
            # Создаем/обновляем .env файл для секретов
            echo "Configuring environment variables..."
            cat > .env <<EOF
            SECRET_TOKEN=${{ secrets.SECRET_TOKEN }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            EOF
            
            # Применяем миграции БД
            echo "Applying database migrations..."
            python3 manage.py makemigrations
            python3 manage.py migrate
            
            # Собираем статические файлы
            echo "Collecting static files..."
            python3 manage.py collectstatic --noinput
            
            # Создаем/перезаписываем файл сервиса Gunicorn с правами суперпользователя
            echo "Creating Gunicorn service file..."
            sudo tee /etc/systemd/system/gunicorn.service > /dev/null <<EOF
            [Unit]
            Description=gunicorn daemon for my_django_sensor
            After=network.target
            
            [Service]
            User=plant-deployer
            Group=www-data
            WorkingDirectory=/home/plant-deployer/plant_monitoring
            ExecStart=/home/plant-deployer/plant_monitoring/venv/bin/gunicorn \
                      --workers 3 \
                      --group www-data \
                      --bind unix:/home/plant-deployer/plant_monitoring/gunicorn.sock \
                      plant_monitoring.wsgi:application
            
            [Install]
            WantedBy=multi-user.target
            EOF
            
            # Перезагружаем systemd, чтобы он увидел новый/измененный файл сервиса
            sudo systemctl daemon-reload
            
            # Перезапускаем Gunicorn
            echo "Restarting Gunicorn..."
            sudo systemctl restart gunicorn
            
            echo "Deployment finished successfully!"